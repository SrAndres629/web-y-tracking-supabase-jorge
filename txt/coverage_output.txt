============================= test session starts =============================
platform win32 -- Python 3.13.1, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\acord\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
metadata: {'Python': '3.13.1', 'Platform': 'Windows-11-10.0.26300-SP0', 'Packages': {'pytest': '8.4.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.9.0', 'hypothesis': '6.151.5', 'libtmux': '0.53.0', 'asyncio': '1.3.0', 'html': '4.2.0', 'metadata': '3.1.1'}}
rootdir: C:\Users\acord\OneDrive\Desktop\paginas web\Paginas web y tracking\Web y tracking-supabase Jorge
plugins: anyio-4.9.0, hypothesis-6.151.5, libtmux-0.53.0, asyncio-1.3.0, html-4.2.0, metadata-3.1.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/03_audit/test_function_coverage.py::test_function_integrity[app/tracking.py] FAILED [ 20%]
tests/03_audit/test_function_coverage.py::test_function_integrity[app/meta_capi.py] PASSED [ 40%]
tests/03_audit/test_function_coverage.py::test_function_integrity[app/database.py] FAILED [ 60%]
tests/03_audit/test_function_coverage.py::test_function_integrity[app/services.py] FAILED [ 80%]
tests/03_audit/test_function_coverage.py::test_unit_test_existence PASSED [100%]

================================== FAILURES ===================================
__________________ test_function_integrity[app/tracking.py] ___________________

module_path = 'app/tracking.py'

    @pytest.mark.parametrize("module_path", CRITICAL_MODULES)
    def test_function_integrity(module_path):
        """
        Ensures every function contributes to the 'Source of Truth'.
        No ghost functions allowed.
        """
        full_path = BASE_DIR / module_path
        if not full_path.exists():
            pytest.skip(f"Module {module_path} not found")

        functions = get_public_functions(full_path)
        violations = []

        for func in functions:
            func_name = func.name

            # 1. Check Docstring
            if not ast.get_docstring(func):
                violations.append(f"Function '{func_name}' is missing a docstring.")

            # 2. Check Type Hints (Args & Return)
            # Note: This is a basic check. Complex types need mypy.
            has_return_annotation = func.returns is not None
            if not has_return_annotation:
                 violations.append(f"Function '{func_name}' is missing return type hint.")

        if violations:
>           pytest.fail(f"\\n\U0001f6a8 INTEGRITY VIOLATION in {module_path}:\\n" + "\\n".join(violations))
E           Failed:
E           \U0001f6a8 INTEGRITY VIOLATION in app/tracking.py:
E           Function 'deduplicate_event' is missing a docstring.
E           Function 'deduplicate_event' is missing return type hint.
E           Function 'cache_visitor_data' is missing a docstring.
E           Function 'cache_visitor_data' is missing return type hint.
E           Function 'get_cached_visitor' is missing a docstring.
E           Function 'get_cached_visitor' is missing return type hint.

tests\03_audit\test_function_coverage.py:66: Failed
__________________ test_function_integrity[app/database.py] ___________________

module_path = 'app/database.py'

    @pytest.mark.parametrize("module_path", CRITICAL_MODULES)
    def test_function_integrity(module_path):
        """
        Ensures every function contributes to the 'Source of Truth'.
        No ghost functions allowed.
        """
        full_path = BASE_DIR / module_path
        if not full_path.exists():
            pytest.skip(f"Module {module_path} not found")

        functions = get_public_functions(full_path)
        violations = []

        for func in functions:
            func_name = func.name

            # 1. Check Docstring
            if not ast.get_docstring(func):
                violations.append(f"Function '{func_name}' is missing a docstring.")

            # 2. Check Type Hints (Args & Return)
            # Note: This is a basic check. Complex types need mypy.
            has_return_annotation = func.returns is not None
            if not has_return_annotation:
                 violations.append(f"Function '{func_name}' is missing return type hint.")

        if violations:
>           pytest.fail(f"\\n\U0001f6a8 INTEGRITY VIOLATION in {module_path}:\\n" + "\\n".join(violations))
E           Failed:
E           \U0001f6a8 INTEGRITY VIOLATION in app/database.py:
E           Function 'get_db_connection' is missing return type hint.
E           Function 'get_cursor' is missing return type hint.
E           Function 'init_tables' is missing return type hint.
E           Function 'save_visitor' is missing a docstring.
E           Function 'save_visitor' is missing return type hint.
E           Function 'get_visitor_fbclid' is missing a docstring.
E           Function 'upsert_contact_advanced' is missing return type hint.
E           Function 'save_message' is missing a docstring.
E           Function 'save_message' is missing return type hint.
E           Function 'get_chat_history' is missing return type hint.
E           Function 'mark_lead_sent' is missing a docstring.
E           Function 'get_user_message_count' is missing a docstring.
E           Function 'check_if_lead_sent' is missing a docstring.
E           Function 'get_or_create_lead' is missing a docstring.
E           Function 'log_interaction' is missing a docstring.
E           Function 'execute' is missing a docstring.
E           Function 'execute' is missing return type hint.
E           Function 'fetchone' is missing a docstring.
E           Function 'fetchone' is missing return type hint.
E           Function 'fetchall' is missing a docstring.
E           Function 'fetchall' is missing return type hint.
E           Function 'close' is missing a docstring.
E           Function 'close' is missing return type hint.
E           Function 'rowcount' is missing a docstring.
E           Function 'rowcount' is missing return type hint.
E           Function 'lastrowid' is missing a docstring.
E           Function 'lastrowid' is missing return type hint.

tests\03_audit\test_function_coverage.py:66: Failed
__________________ test_function_integrity[app/services.py] ___________________

module_path = 'app/services.py'

    @pytest.mark.parametrize("module_path", CRITICAL_MODULES)
    def test_function_integrity(module_path):
        """
        Ensures every function contributes to the 'Source of Truth'.
        No ghost functions allowed.
        """
        full_path = BASE_DIR / module_path
        if not full_path.exists():
            pytest.skip(f"Module {module_path} not found")

        functions = get_public_functions(full_path)
        violations = []

        for func in functions:
            func_name = func.name

            # 1. Check Docstring
            if not ast.get_docstring(func):
                violations.append(f"Function '{func_name}' is missing a docstring.")

            # 2. Check Type Hints (Args & Return)
            # Note: This is a basic check. Complex types need mypy.
            has_return_annotation = func.returns is not None
            if not has_return_annotation:
                 violations.append(f"Function '{func_name}' is missing return type hint.")

        if violations:
>           pytest.fail(f"\\n\U0001f6a8 INTEGRITY VIOLATION in {module_path}:\\n" + "\\n".join(violations))
E           Failed:
E           \U0001f6a8 INTEGRITY VIOLATION in app/services.py:
E           Function 'get_services_config' is missing a docstring.
E           Function 'get_contact_config' is missing a docstring.
E           Function 'publish_to_qstash' is missing return type hint.
E           Function 'warm_cache' is missing return type hint.
E           Function 'refresh_all' is missing return type hint.

tests\03_audit\test_function_coverage.py:66: Failed
=========================== short test summary info ===========================
FAILED tests/03_audit/test_function_coverage.py::test_function_integrity[app/tracking.py]
FAILED tests/03_audit/test_function_coverage.py::test_function_integrity[app/database.py]
FAILED tests/03_audit/test_function_coverage.py::test_function_integrity[app/services.py]
========================= 3 failed, 2 passed in 1.02s =========================
