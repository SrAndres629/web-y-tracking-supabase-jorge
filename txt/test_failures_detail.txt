============================= test session starts =============================
platform win32 -- Python 3.13.1, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\acord\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
metadata: {'Python': '3.13.1', 'Platform': 'Windows-11-10.0.26300-SP0', 'Packages': {'pytest': '8.4.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.9.0', 'hypothesis': '6.151.5', 'libtmux': '0.53.0', 'asyncio': '1.3.0', 'html': '4.2.0', 'metadata': '3.1.1'}}
rootdir: C:\Users\acord\OneDrive\Desktop\paginas web\Paginas web y tracking\Web y tracking-supabase Jorge
plugins: anyio-4.9.0, hypothesis-6.151.5, libtmux-0.53.0, asyncio-1.3.0, html-4.2.0, metadata-3.1.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 11 items

tests/01_unit/test_tracking_math.py::test_entropy_collision_resistance PASSED [  9%]
tests/01_unit/test_tracking_math.py::test_id_structure_strictness PASSED [ 18%]
tests/01_unit/test_tracking_math.py::test_monotonicity PASSED            [ 27%]
tests/01_unit/test_tracking_math.py::test_fbp_statistical_distribution PASSED [ 36%]
tests/01_unit/test_tracking_math.py::test_hashing_consistency_math_email PASSED [ 45%]
tests/01_unit/test_tracking_math.py::test_hashing_consistency_math_phone PASSED [ 54%]
tests/01_unit/test_tracking_math.py::test_deduplication_idempotency_math PASSED [ 63%]
tests/01_unit/test_meta_capi.py::test_enhanced_user_data_hashing PASSED  [ 72%]
tests/01_unit/test_meta_capi.py::test_deduplication_logic FAILED         [ 81%]
tests/01_unit/test_meta_capi.py::test_sandbox_interception FAILED        [ 90%]
C:\Users\acord\AppData\Local\Programs\Python\Python313\Lib\site-packages\_pytest\unraisableexception.py:33: RuntimeWarning: coroutine 'EliteMetaCAPIService.send_event' was never awaited
  gc.collect()
RuntimeWarning: Enable tracemalloc to get the object allocation traceback
tests/01_unit/test_meta_capi.py::test_fallback_mechanism FAILED          [100%]

================================== FAILURES ===================================
__________________________ test_deduplication_logic ___________________________

capi_service = <app.meta_capi.EliteMetaCAPIService object at 0x00000202FC95FED0>

    def test_deduplication_logic(capi_service):
        """
        Verifies that duplicate events are blocked
        """
        event_id = "evt_123"
        event_name = "Purchase"
    
        # Mock deduplicate to return False (Duplicate found)
        capi_service._deduplicate = MagicMock(return_value=False)
    
        result = capi_service.send_event(
            event_name=event_name,
            event_id=event_id,
            event_source_url="http://test.com",
            user_data=EnhancedUserData()
        )
    
>       assert result["status"] == "duplicate"
               ^^^^^^^^^^^^^^^^
E       TypeError: 'coroutine' object is not subscriptable

tests\01_unit\test_meta_capi.py:66: TypeError
__________________________ test_sandbox_interception __________________________

capi_service = <app.meta_capi.EliteMetaCAPIService object at 0x00000202FC86F610>

    def test_sandbox_interception(capi_service):
        """
        Verifies that Sandbox Mode prevents sending
        """
        capi_service.sandbox_mode = True
    
        result = capi_service.send_event(
            event_name="Lead",
            event_id="evt_test",
            event_source_url="http://test.com",
            user_data=EnhancedUserData()
        )
    
>       assert result["status"] == "sandbox"
               ^^^^^^^^^^^^^^^^
E       TypeError: 'coroutine' object is not subscriptable

tests\01_unit\test_meta_capi.py:82: TypeError
___________________________ test_fallback_mechanism ___________________________

capi_service = <app.meta_capi.EliteMetaCAPIService object at 0x00000202FC8CDCD0>

    def test_fallback_mechanism(capi_service):
        """
        Verifies that if SDK is missing, it falls back to HTTP
        """
        with patch("app.meta_capi.SDK_AVAILABLE", False):
            with patch("app.tracking.send_event", return_value=True) as mock_http_send:
    
                user_data = EnhancedUserData(email="test@test.com")
    
                result = capi_service.send_event(
                    event_name="Lead",
                    event_id="evt_fallback",
                    event_source_url="http://test.com",
                    user_data=user_data
                )
    
>               assert result["status"] == "success"
                       ^^^^^^^^^^^^^^^^
E               TypeError: 'coroutine' object is not subscriptable

tests\01_unit\test_meta_capi.py:100: TypeError
=========================== short test summary info ===========================
FAILED tests/01_unit/test_meta_capi.py::test_deduplication_logic - TypeError: 'coroutine' object is not subscriptable
FAILED tests/01_unit/test_meta_capi.py::test_sandbox_interception - TypeError: 'coroutine' object is not subscriptable
FAILED tests/01_unit/test_meta_capi.py::test_fallback_mechanism - TypeError: 'coroutine' object is not subscriptable
========================= 3 failed, 8 passed in 3.11s =========================
<sys>:0: RuntimeWarning: coroutine 'EliteMetaCAPIService.send_event' was never awaited
