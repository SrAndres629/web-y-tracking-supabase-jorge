<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/assets/images/branding/luxury_logo.svg?v={{ system_version }}">

    <!-- üõ°Ô∏è GLOBAL CACHE INVALIDATION (Diamond Standard) -->
    <!-- üõ°Ô∏è OPTIMIZED CACHE POLICY (Smart Revalidation) -->
    <!-- HTML: Cache for 1h, revalidate after -->
    <meta http-equiv="Cache-Control" content="public, max-age=3600, stale-while-revalidate=86400">

    <!-- Component-specific styles loaded on demand -->

    <!-- Theme Bridge: Unificaci√≥n Luxury ‚Üî Neuro-Vision -->
    <link rel="stylesheet" href="/static/design-system/tokens/theme-bridge.css?v={{ system_version }}">
    
    <!-- Global selection style -->
    <style>::selection{background-color:#C5A059;color:#000}</style>

    <!-- SEO Core Tags (Dynamic Silicon Valley Hub) -->
    <title>{% block title %}{{ seo.title if seo and seo.title else "Jorge Aguirre Flores | Maquillaje Permanente en
        Santa Cruz" }}{% endblock %}</title>
    {% block meta_tags %}
    <meta name="description"
        content="{{ seo.description if seo and seo.description else 'Especialista en Microblading, Delineado Permanente y Labios. 30 a√±os de experiencia en Santa Cruz de la Sierra.' }}">
    <meta name="author" content="Jorge Aguirre Flores">
    <meta name="robots" content="{{ seo.robots if seo and seo.robots else 'index, follow' }}">
    <link rel="canonical" href="{{ seo.canonical if seo and seo.canonical else 'https://jorgeaguirreflores.com/' }}">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title"
        content="{{ seo.og_title if seo and seo.og_title else 'Jorge Aguirre Flores | Maquillaje Permanente Premium' }}">
    <meta property="og:description"
        content="{{ seo.description if seo and seo.description else '30 a√±os transformando miradas en Santa Cruz. Microblading, Delineado y Labios.' }}">
    <meta property="og:url"
        content="{{ seo.canonical if seo and seo.canonical else 'https://jorgeaguirreflores.com/' }}">
    <meta property="og:image"
        content="{{ seo.og_image if seo and seo.og_image else 'https://jorgeaguirreflores.com/static/assets/images/meta/og-image.webp' }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="es_BO">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title"
        content="{{ seo.og_title if seo and seo.og_title else 'Jorge Aguirre Flores | Maquillaje Permanente Premium' }}">
    <meta name="twitter:description"
        content="{{ seo.description if seo and seo.description else '30 a√±os transformando miradas en Santa Cruz. Microblading, Delineado y Labios.' }}">
    <meta name="twitter:image"
        content="{{ seo.og_image if seo and seo.og_image else 'https://jorgeaguirreflores.com/static/assets/images/meta/og-image.webp' }}">
    {% endblock %}

    <!-- Semantic Data (JSON-LD) -->
    {% if seo and seo.json_ld %}
    {{ seo.json_ld | safe }}
    {% endif %}
    {% block extra_schema %}{% endblock %}

    <!-- Cloudflare Zaraz handles Meta Pixel (Auto-Injected) -->
    <!-- End Meta Pixel -->

    <!-- Critical CSS: Solo above-the-fold esencial -->
    <style>:root{--bg:#050505;--text:#f5f5f7;--gold:#c5a059}*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{font-family:Inter,system-ui,sans-serif;-webkit-font-smoothing:antialiased}body{background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;overflow-x:hidden}.hero{min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;padding:2rem}.hero h1{font-size:clamp(2rem,5vw,4rem);font-weight:700;text-align:center;line-height:1.1;margin-bottom:1rem}.hero h1 .text-gradient-gold{background:linear-gradient(135deg,var(--gold) 0%,#e5c585 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.hero h2{font-size:clamp(1rem,3vw,1.5rem);color:hsla(0,0%,100%,.6);text-align:center;font-weight:400;margin-bottom:2rem}.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:1rem 2rem;font-size:1rem;font-weight:600;text-decoration:none;border-radius:.5rem;transition:all .3s ease;cursor:pointer;border:none;min-height:48px;min-width:48px}.btn-primary{background:linear-gradient(135deg,var(--gold) 0%,#e5c585 100%);color:var(--bg)}nav{position:fixed;top:0;left:0;right:0;z-index:50;padding:1rem 2rem;background:rgba(5,5,5,.8);backdrop-filter:blur(10px)}.skip-link{position:absolute;top:-40px;left:0;background:var(--gold);color:var(--bg);padding:8px;text-decoration:none;z-index:100}.skip-link:focus{top:0}@media(max-width:768px){a,button{min-height:44px;min-width:44px}}</style>
    
    <!-- Async load non-critical CSS -->
    <link rel="preload" href="/static/dist/css/app.min.css?v={{ system_version }}" as="style">
    <link rel="stylesheet" href="/static/dist/css/app.min.css?v={{ system_version }}" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="/static/dist/css/app.min.css?v={{ system_version }}">
    </noscript>

    <!-- Google Fonts + Icons (Apple Standard: Inter Variable) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- Async Font Awesome -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style"
        onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    <!-- Cloudflare Turnstile (Anti-Bot Protection) -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer data-cfasync="false"></script>

    <!-- GSAP (Core Animation Engine) with SRI -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" integrity="sha512-7eHRwcbYkK4d9g/6tD/mhkf++eoTHwpNM9woBxtP6WfhtNe0ewW+EJ1OBoF8qP5dd1l9QvG9+N/Px/xCq7R8lQ==" crossorigin="anonymous"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" integrity="sha512-onMTRKJBKz8M1TnqqDuGBlowlP7gC/Oqg2LbLl1Q9WekJ1Cq8bM5w1K8lqmMA4x2oV8U5P5v5sXKM5C8Ba0HlQ==" crossorigin="anonymous"></script>

    <!-- Lenis Smooth Scroll -->
    <script defer src="https://unpkg.com/lenis@1.1.18/dist/lenis.min.js" crossorigin="anonymous"></script>

    <!-- üõ°Ô∏è SENTRY (Frontend Error Monitoring) - Configured via Zaraz/backend -->

    <!-- üöÄ MICROSOFT CLARITY (Managed via Cloudflare Zaraz Dashboard) -->
    <!-- To add Clarity as a Zaraz tool: Cloudflare Dashboard > Zaraz > Tools > Add Tool > Microsoft Clarity -->
    <!-- This removes inline scripts for better consent management and performance -->

    <!-- Google One Tap (Identity Resolution) -->
    {% if google_client_id %}
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        window.addEventListener('load', function () {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: '{{ google_client_id }}',
                    use_fedcm_for_prompt: true, // Silicon Valley Compliance: FedCM Migration
                    callback: function (response) {
                        const debug = new URLSearchParams(window.location.search).has('debug');
                        if (debug) Logger.debug('üîç Google Identity Response received');
                        fetch('/api/identity/google', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ credential: response.credential })
                        }).then(function (r) { return r.json(); })
                            .then(function (data) {
                                if (debug) Logger.debug('‚úÖ Identity captured', data.user?.email);
                                // Silicon Valley Identity Link: Update Pixel Advanced Matching
                                if (data.user && window.TrackingEngine) {
                                    window.TrackingEngine.PixelBridge.setUserData({
                                        email: data.user.email,
                                        firstName: data.user.given_name,
                                        lastName: data.user.family_name
                                    });
                                }
                            })
                            .catch(function (e) {
                                console.error('‚ùå Identity capture error:', e);
                            });
                    },
                    auto_select: true,
                    cancel_on_tap_outside: false
                });

                // Enhanced monitoring for Google One Tap prompts
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed()) {
                        console.warn('‚ö†Ô∏è Google One Tap not displayed:', notification.getNotDisplayedReason());
                    } else if (notification.isSkippedMoment()) {
                        console.warn('‚ö†Ô∏è Google One Tap skipped:', notification.getSkippedReason());
                    } else if (notification.isDismissedMoment()) {
                        console.warn('‚ö†Ô∏è Google One Tap dismissed:', notification.getDismissedReason());
                    }
                });
            } else {
                console.error('‚ùå Google GSI library not loaded or configured.');
            }
        });
    </script>
    {% endif %}
    <!-- End Google One Tap -->

    {% block extra_head %}{% endblock %}

    <!-- Dynamic Configuration (Server-side rendered data) -->
    {# Transform services list to dict indexed by id for frontend tracking #}
    {%- set services_dict = {} -%}
    {%- for svc in services -%}
    {%- set _ = services_dict.update({svc.id: {
    "name": svc.title,
    "category": svc.subtitle | default('Servicio'),
    "price": 0,
    "image": svc.image | default('')
    }}) -%}
    {%- endfor -%}
    {# Add powder_brows as alias for microblading for tracking consistency #}
    {%- if 'microblading' in services_dict and 'powder_brows' not in services_dict -%}
    {%- set _ = services_dict.update({"powder_brows": services_dict.microblading}) -%}
    {%- endif -%}
    <!-- üõ°Ô∏è SILICON VALLEY CORE: Logger & Config -->
    <script type="module">
        import { Logger } from '/static/engines/core/logger.js?v={{ system_version }}';
        window.Logger = Logger;
    </script>

    <script type="application/json" id="app-config">
        {
            "META_PIXEL_ID": "{{ pixel_id }}",
            "META_EVENT_ID": "{{ pageview_event_id }}",
            "EXTERNAL_ID": "{{ external_id }}",
            "SERVICES_CONFIG": {{ services_dict | tojson }},
            "CONTACT_CONFIG": {{ contact | tojson }}
        }
    </script>

    <!-- Initialize config from JSON (lint-safe) -->
    <script>
        (function () {
            try {
                const configElement = document.getElementById('app-config');
                if (configElement) {
                    const config = JSON.parse(configElement.textContent);
                    window.META_PIXEL_ID = config.META_PIXEL_ID;
                    window.META_EVENT_ID = config.META_EVENT_ID;
                    window.EXTERNAL_ID = config.EXTERNAL_ID;
                    window.SERVICES_CONFIG = config.SERVICES_CONFIG;
                    window.CONTACT_CONFIG = config.CONTACT_CONFIG;
                }
            } catch (e) {
                console.error("Error loading app-config", e);
            }
        })();
    </script>

    {% block schema %}{% endblock %}
</head>

<body
    class="bg-luxury-black text-luxury-text font-sans antialiased selection:bg-luxury-gold selection:text-black relative">

    <!-- Anti-Bot Defense Layer -->
    <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-callback="onTurnstileSuccess"
        data-size="invisible"></div>


    <!-- Global Ambient Spotlight -->
    <div id="mouse-spotlight"
        class="fixed inset-0 pointer-events-none z-0 opacity-40 mix-blend-screen transition-opacity duration-1000">
    </div>

    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>

    <!-- Cloudflare Zaraz (Noscript Fallback) -->
    <noscript>
        <img height="1" width="1" style="display:none" alt=""
            src="https://www.facebook.com/tr?id={{ pixel_id }}&ev=PageView&noscript=1" />
    </noscript>

    <!-- Navigation -->
    {% include 'components/navbar.html' ignore missing %}

    <!-- Main Content -->
    <main id="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    {% include 'components/footer.html' ignore missing %}

    <!-- Global Scripts (Atomic Architecture v4.0 - ES Modules) -->
    <!-- ‚úÖ ES Modules para siempre tener c√≥digo actualizado -->
    <script type="module" id="scroll-init">
        import { TrackingEngine } from '/static/engines/tracking/index.js?v={{ system_version }}';
        import { SliderManager } from '/static/engines/ui/slider-manager.js?v={{ system_version }}';
        import { AOSReplacement } from '/static/engines/motion/aos-replacement.js?v={{ system_version }}';
        import { LenisSetup } from '/static/engines/motion/lenis-setup.js?v={{ system_version }}';

        // Wait for DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEngines);
        } else {
            initEngines();
        }

        function initEngines() {
            const debug = new URLSearchParams(window.location.search).has('debug_pixel');
            const isMobile = window.matchMedia('(pointer: coarse)').matches;

            // 1. Lenis Smooth Scroll + GSAP Sync
            const lenis = LenisSetup.init();
            if (lenis) {
                LenisSetup.syncWithGSAP();
                window.lenis = lenis;
            }

            // 2. Tracking Engine (Zaraz + CAPI)
            if (typeof TrackingEngine !== 'undefined') {
                TrackingEngine.init({ debug: debug });
                window.TrackingEngine = TrackingEngine;
            }

            // 3. Sliders (Before/After) - Enhanced version for mobile
            if (isMobile) {
                // Load enhanced slider with Hammer.js for mobile
                import('/static/engines/ui/slider-manager-enhanced.js?v={{ system_version }}')
                    .then(module => {
                        if (module.SliderManagerEnhanced) {
                            const slider = new module.SliderManagerEnhanced();
                            slider.init();
                            window.SliderManager = slider;
                        }
                    })
                    .catch(() => {
                        // Fallback to basic slider
                        if (typeof SliderManager !== 'undefined') {
                            SliderManager.init();
                        }
                    });
            } else {
                // Desktop: use basic slider
                if (typeof SliderManager !== 'undefined') {
                    SliderManager.init();
                }
            }

            // 4. Animaciones (AOS Replacement)
            if (typeof AOSReplacement !== 'undefined') {
                AOSReplacement.init();
            }

            // 5. Theme Bridge initialization
            document.body.classList.add('theme-bridge-loaded');
            
            if (debug) Logger.debug('[MainEngine] All engines initialized. Mobile:', isMobile);
        }
    </script>
    {% block extra_scripts %}{% endblock %}
    <!-- Vercel Services (Updated) -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <script defer src="/_vercel/speed-insights/script.js"></script>

    <!-- üåÄ MASTER UX ENGINE: Managed via MotionEngine in legacy-adapter.js -->
</body>

</html>