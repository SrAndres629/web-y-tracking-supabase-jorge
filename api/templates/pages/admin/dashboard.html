{% extends "layouts/base_admin.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-luxury-dark rounded-lg p-4 border border-gray-800">
        <div class="text-gray-500 text-sm">Total Visitantes</div>
        <div class="text-2xl font-bold text-white">{{ visitors|length }}</div>
    </div>
    <div class="bg-luxury-dark rounded-lg p-4 border border-gray-800">
        <div class="text-gray-500 text-sm">Con FBCLID (Ads)</div>
        <div class="text-2xl font-bold text-green-400">{{ visitors|selectattr('fbclid')|list|length }}</div>
    </div>
    <div class="bg-luxury-dark rounded-lg p-4 border border-gray-800">
        <div class="text-gray-500 text-sm">EMQ Global Avg</div>
        <div class="text-2xl font-bold text-luxury-gold">
            {% set total_score = 0 %}
            {% if emq_stats %}
            {% for stat in emq_stats %}{% set total_score = total_score + stat.avg_score %}{% endfor %}
            {{ (total_score / emq_stats|length)|round(1) }}
            {% else %}0.0{% endif %}
        </div>
    </div>
    <div class="bg-luxury-dark rounded-lg p-4 border border-gray-800">
        <div class="text-gray-500 text-sm">Estado Motor</div>
        <div class="text-lg font-bold text-green-500">
            <i class="fas fa-satellite-dish mr-2 animate-pulse"></i> Activo
        </div>
    </div>
</div>

<!-- EMQ Breakdown -->
<div class="bg-luxury-dark rounded-lg border border-gray-800 overflow-hidden mb-8">
    <div class="px-4 py-3 border-b border-gray-800 flex justify-between items-center">
        <h2 class="font-bold text-white"><i class="fas fa-signal mr-2 text-luxury-gold"></i> Calidad de Se√±al por Evento
            (EMQ Monitor)</h2>
        <span class="text-xs text-gray-500">Actualizado hace unos segundos</span>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-900 text-gray-400 text-left">
                <tr>
                    <th class="px-4 py-3">Evento</th>
                    <th class="px-4 py-3">Score Promedio</th>
                    <th class="px-4 py-3">Volumen (24h)</th>
                    <th class="px-4 py-3">Calidad</th>
                    <th class="px-4 py-3">√öltimo Env√≠o</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in emq_stats %}
                <tr class="border-t border-gray-800 hover:bg-gray-900/50">
                    <td class="px-4 py-3 font-medium text-white">{{ stat.event_name }}</td>
                    <td class="px-4 py-3">
                        <span
                            class="text-lg font-bold {% if stat.avg_score >= 8 %}text-green-400{% elif stat.avg_score >= 6 %}text-yellow-400{% else %}text-red-400{% endif %}">
                            {{ stat.avg_score|round(1) }}/10
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-400">{{ stat.count }} eventos</td>
                    <td class="px-4 py-3">
                        {% if stat.avg_score >= 8 %}
                        <span
                            class="px-2 py-1 bg-green-900/30 text-green-400 text-xs rounded-full border border-green-800/50">Excelente</span>
                        {% elif stat.avg_score >= 6 %}
                        <span
                            class="px-2 py-1 bg-yellow-900/30 text-yellow-400 text-xs rounded-full border border-yellow-800/50">Aceptable</span>
                        {% else %}
                        <span
                            class="px-2 py-1 bg-red-900/30 text-red-400 text-xs rounded-full border border-red-800/50">Cr√≠tico</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-gray-500">{{ stat.last_seen }}</td>
                </tr>
                {% endfor %}
                {% if not emq_stats %}
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500 italic">
                        Sin datos de EMQ registrados a√∫n.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Visitors Table -->
<div class="bg-luxury-dark rounded-lg border border-gray-800 overflow-hidden">
    <div class="px-4 py-3 border-b border-gray-800">
        <h2 class="font-bold text-white"><i class="fas fa-users mr-2"></i> √öltimos 50 Visitantes</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-900 text-gray-400 text-left">
                <tr>
                    <th class="px-4 py-3">ID</th>
                    <th class="px-4 py-3">Fecha</th>
                    <th class="px-4 py-3">Fuente</th>
                    <th class="px-4 py-3">IP</th>
                    <th class="px-4 py-3">Dispositivo</th>
                    <th class="px-4 py-3">FBCLID</th>
                    <th class="px-4 py-3">Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for v in visitors %}
                <tr class="border-t border-gray-800 hover:bg-gray-900/50" id="row-{{ v.id }}">
                    <td class="px-4 py-3 text-gray-500">#{{ v.id }}</td>
                    <td class="px-4 py-3">{{ v.timestamp[:16] if v.timestamp else 'N/A' }}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs
                            {% if 'lead' in (v.source or '') %}bg-green-900 text-green-300
                            {% elif 'pageview' in (v.source or '') %}bg-blue-900 text-blue-300
                            {% else %}bg-gray-800 text-gray-400{% endif %}">
                            {{ v.source or 'pageview' }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-gray-500">{{ v.ip_address[:15] if v.ip_address else 'N/A' }}...</td>
                    <td class="px-4 py-3 text-gray-500 max-w-[200px] truncate">
                        {{ v.user_agent[:50] if v.user_agent else 'N/A' }}...
                    </td>
                    <td class="px-4 py-3">
                        {% if v.fbclid %}
                        <span class="text-green-400"><i class="fas fa-check-circle"></i> S√≠</span>
                        {% else %}
                        <span class="text-gray-600"><i class="fas fa-times-circle"></i> No</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if v.fbclid %}
                        <button type="button" data-visitor-id="{{ v.id }}" id="btn-{{ v.id }}"
                            class="confirm-sale-btn px-3 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded transition">
                            üí∞ Confirmar Venta
                        </button>
                        {% else %}
                        <span class="text-gray-600 text-xs">Sin tracking</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not visitors %}
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i><br>
                        No hay visitantes registrados a√∫n.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Event delegation for confirm sale buttons
    document.addEventListener('DOMContentLoaded', function () {
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('confirm-sale-btn')) {
                const visitorId = e.target.getAttribute('data-visitor-id');
                if (visitorId) {
                    confirmSale(visitorId);
                }
            }
        });
    });

    async function confirmSale(visitorId) {
        const btn = document.getElementById('btn-' + visitorId);
        if (!btn) return;

        btn.disabled = true;
        btn.innerHTML = '‚è≥ Enviando...';

        try {
            const response = await fetch('/admin/confirm/' + visitorId, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                }
            });
            const data = await response.json();

            if (data.status === 'success') {
                btn.innerHTML = '‚úÖ Confirmado';
                btn.className = 'px-3 py-1 bg-gray-700 text-gray-400 text-xs font-bold rounded cursor-not-allowed';
                alert('üéâ ¬°Venta registrada en Meta!\n\nEvento Purchase enviado correctamente.');
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        } catch (error) {
            btn.innerHTML = '‚ùå Error';
            btn.className = 'px-3 py-1 bg-red-600 text-white text-xs font-bold rounded';
            btn.disabled = false;
            alert('Error: ' + error.message);
        }
    }
</script>
{% endblock %}