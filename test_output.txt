============================= test session starts =============================
platform win32 -- Python 3.13.1, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\acord\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
hypothesis profile 'default'
metadata: {'Python': '3.13.1', 'Platform': 'Windows-11-10.0.26300-SP0', 'Packages': {'pytest': '8.4.2', 'pluggy': '1.6.0'}, 'Plugins': {'anyio': '4.9.0', 'hypothesis': '6.151.5', 'libtmux': '0.53.0', 'asyncio': '1.3.0', 'html': '4.2.0', 'metadata': '3.1.1'}}
rootdir: C:\Users\acord\OneDrive\Desktop\paginas web\Paginas web y tracking\Web y tracking-supabase Jorge
plugins: anyio-4.9.0, hypothesis-6.151.5, libtmux-0.53.0, asyncio-1.3.0, html-4.2.0, metadata-3.1.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/03_audit/test_infrastructure.py::test_environment_variables SKIPPED
tests/03_audit/test_infrastructure.py::test_database_connection FAILED
tests/03_audit/test_infrastructure.py::test_redis_connection SKIPPED

================================== FAILURES ===================================
__________________________ test_database_connection ___________________________

    def test_database_connection():
        """Prueba de conexi¾n a Supabase (Postgres)"""
        db_url = (settings.DATABASE_URL or "").lower()
        is_prod = os.getenv("VERCEL") or os.getenv("RENDER")
    
        # Detect placeholders in DSN
        if not db_url or "set_in_production" in db_url or "stub" in db_url:
            if is_prod:
                pytest.fail("\U0001f6a8 PRODUCTION ERROR: DATABASE_URL contains a placeholder.")
            else:
                logger.info("\u26a0\ufe0f Stub/Placeholder DSN detected. Verifying SQLite fallback path.")
                from app.database import get_db_connection
                try:
>                   with get_db_connection() as conn:
                         ^^^^^^^^^^^^^^^^^^^

tests\03_audit\test_infrastructure.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\acord\AppData\Local\Programs\Python\Python313\Lib\contextlib.py:141: in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
app\database.py:58: in get_db_connection
    raise e
app\database.py:52: in get_db_connection
    conn = _establish_connection()
           ^^^^^^^^^^^^^^^^^^^^^^^
app\database.py:64: in _establish_connection
    return psycopg2.connect(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

dsn = 'user=mock password=mock dbname=db host=localhost port=5432 connect_timeout=5 sslmode=require'
connection_factory = None, cursor_factory = None
kwargs = {'connect_timeout': 5, 'sslmode': 'require'}, kwasync = {}

    def connect(dsn=None, connection_factory=None, cursor_factory=None, **kwargs):
        """
        Create a new database connection.
    
        The connection parameters can be specified as a string:
    
            conn = psycopg2.connect("dbname=test user=postgres password=secret")
    
        or using a set of keyword arguments:
    
            conn = psycopg2.connect(database="test", user="postgres", password="secret")
    
        Or as a mix of both. The basic connection parameters are:
    
        - *dbname*: the database name
        - *database*: the database name (only as keyword argument)
        - *user*: user name used to authenticate
        - *password*: password used to authenticate
        - *host*: database host address (defaults to UNIX socket if not provided)
        - *port*: connection port number (defaults to 5432 if not provided)
    
        Using the *connection_factory* parameter a different class or connections
        factory can be specified. It should be a callable object taking a dsn
        argument.
    
        Using the *cursor_factory* parameter, a new default cursor factory will be
        used by cursor().
    
        Using *async*=True an asynchronous connection will be created. *async_* is
        a valid alias (for Python versions where ``async`` is a keyword).
    
        Any other keyword parameter will be passed to the underlying client
        library: the list of supported parameters depends on the library version.
    
        """
        kwasync = {}
        if 'async' in kwargs:
            kwasync['async'] = kwargs.pop('async')
        if 'async_' in kwargs:
            kwasync['async_'] = kwargs.pop('async_')
    
        dsn = _ext.make_dsn(dsn, **kwargs)
>       conn = _connect(dsn, connection_factory=connection_factory, **kwasync)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       psycopg2.OperationalError: connection to server at "localhost" (::1), port 5432 failed: Connection refused (0x0000274D/10061)
E       	Is the server running on that host and accepting TCP/IP connections?
E       connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)
E       	Is the server running on that host and accepting TCP/IP connections?

C:\Users\acord\AppData\Local\Programs\Python\Python313\Lib\site-packages\psycopg2\__init__.py:135: OperationalError

During handling of the above exception, another exception occurred:

    def test_database_connection():
        """Prueba de conexi¾n a Supabase (Postgres)"""
        db_url = (settings.DATABASE_URL or "").lower()
        is_prod = os.getenv("VERCEL") or os.getenv("RENDER")
    
        # Detect placeholders in DSN
        if not db_url or "set_in_production" in db_url or "stub" in db_url:
            if is_prod:
                pytest.fail("\U0001f6a8 PRODUCTION ERROR: DATABASE_URL contains a placeholder.")
            else:
                logger.info("\u26a0\ufe0f Stub/Placeholder DSN detected. Verifying SQLite fallback path.")
                from app.database import get_db_connection
                try:
                    with get_db_connection() as conn:
                        cur = conn.cursor()
                        cur.execute("SELECT 1")
                        assert cur.fetchone() is not None
                    pytest.skip("\u2705 SQLite connection verified. Skipping real Postgres check (Local).")
                except Exception as e:
>                   pytest.fail(f"\U0001f525 Fallo conexi\xf3n SQLite Fallback: {str(e)}")
E                   Failed: \U0001f525 Fallo conexi\xf3n SQLite Fallback: connection to server at "localhost" (::1), port 5432 failed: Connection refused (0x0000274D/10061)
E                   	Is the server running on that host and accepting TCP/IP connections?
E                   connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)
E                   	Is the server running on that host and accepting TCP/IP connections?

tests\03_audit\test_infrastructure.py:64: Failed
------------------------------ Captured log call ------------------------------
ERROR    app.database:database.py:92 \U0001f525 Database Transaction Error: connection to server at "localhost" (::1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?\nconnection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?
=========================== short test summary info ===========================
FAILED tests/03_audit/test_infrastructure.py::test_database_connection - Fail...
======================== 1 failed, 2 skipped in 4.76s =========================
