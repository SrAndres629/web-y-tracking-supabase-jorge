[1m============================= test session starts ==============================[0m
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
hypothesis profile 'default'
rootdir: /home/jorand/antigravityobuntu/tests
configfile: pytest.ini
plugins: logfire-4.24.0, Faker-40.4.0, anyio-4.12.1, cov-7.0.0, locust-2.43.3, hypothesis-6.151.9, asyncio-1.3.0, mock-3.15.1
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
[1mcollecting ... [0m
[1m----------------------------- live log collection ------------------------------[0m
2026-02-17 23:27:44 - app.config - [32mINFO[0m - ğŸš€ TEMPLATE RESOLUTION: Found 1 potential paths
2026-02-17 23:27:44 - app.config - [32mINFO[0m - âœ… ConfiguraciÃ³n cargada correctamente
2026-02-17 23:27:44 - app.limiter - [32mINFO[0m - ğŸŒ€ Rate Limiter using Redis storage: concise-reindeer-45748.upstash.io:6379/0
2026-02-17 23:27:45 - app.infrastructure.persistence.deduplication_service - [32mINFO[0m - âœ… DeduplicationService: Redis connected.
2026-02-17 23:27:45 - BackgroundWorker - [32mINFO[0m - ğŸ’ SYSTEM CORE: Version 1771385265 initialized.
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ”® Neuro-Vision routes mounted at /vision
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ›¡ï¸ Consent routes mounted at /consent
2026-02-17 23:27:45 - app.interfaces.api.middleware.error_handler - [32mINFO[0m - âœ… Error handlers configurados
2026-02-17 23:27:45 - main - [32mINFO[0m - âœ… Error handlers configurados
collected 2 items

tests/L3_modules/test_strict_turnstile.py::test_zero_tolerance_turnstile_missing 
[1m-------------------------------- live log setup --------------------------------[0m
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸš€ Iniciando Jorge Aguirre Flores Web v3.0.0 (Atomic Architecture Mode)
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ§ª Test mode detected: skipping warm_cache and init_tables
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ“Š Meta Pixel ID: 1412977383680793
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸŒ Servidor listo en http://0.0.0.0:8000
DEBUG: settings.TURNSTILE_SECRET_KEY in test = ''
[1m-------------------------------- live log call ---------------------------------[0m
2026-02-17 23:27:45 - uvicorn.error - [33mWARNING[0m - âš ï¸ TURNSTILE_SECRET_KEY not set (Value: '') â€” bot protection DISABLED.
2026-02-17 23:27:46 - httpx - [32mINFO[0m - HTTP Request: POST https://qstash.upstash.io/v2/publish/https://jorgeaguirreflores.com/hooks/process-event "HTTP/1.1 404 Not Found"
2026-02-17 23:27:46 - uvicorn.error - [31m[1mERROR[0m - âŒ QStash HTTP Error: 404 - {"error":"user bc0e128f-928d-4f0d-8c60-e24f2353c4dc not found"}
Traceback (most recent call last):
  File "/home/jorand/antigravityobuntu/app/services/__init__.py", line 302, in publish_to_qstash
    response.raise_for_status()
  File "/home/jorand/.local/lib/python3.10/site-packages/httpx/_models.py", line 829, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '404 Not Found' for url 'https://qstash.upstash.io/v2/publish/https://jorgeaguirreflores.com/hooks/process-event'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/404
2026-02-17 23:27:48 - BackgroundWorker - [32mINFO[0m - âœ… [BG] Visitor saved: anon...
2026-02-17 23:27:48 - httpx - [32mINFO[0m - HTTP Request: POST https://concise-reindeer-45748.upstash.io "HTTP/1.1 200 OK"
2026-02-17 23:27:48 - app.infrastructure.persistence.deduplication_service - [32mINFO[0m - ğŸ›‘ Duplicate detected: evt:evt_123_hack
2026-02-17 23:27:48 - uvicorn.error - [32mINFO[0m - ğŸ”„ [DEDUP ASYNC] Skipped duplicate Lead
2026-02-17 23:27:48 - BackgroundWorker - [32mINFO[0m - âœ… [BG] Meta Event sent: Lead
2026-02-17 23:27:48 - httpx - [32mINFO[0m - HTTP Request: POST http://testserver/track/event "HTTP/1.1 200 OK"
[31mFAILED[0m
[1m------------------------------ live log teardown -------------------------------[0m
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸ›‘ Deteniendo servidor...

tests/L3_modules/test_strict_turnstile.py::test_zero_tolerance_turnstile_invalid 
[1m-------------------------------- live log setup --------------------------------[0m
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸš€ Iniciando Jorge Aguirre Flores Web v3.0.0 (Atomic Architecture Mode)
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸ§ª Test mode detected: skipping warm_cache and init_tables
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸ“Š Meta Pixel ID: 1412977383680793
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸŒ Servidor listo en http://0.0.0.0:8000
[1m-------------------------------- live log call ---------------------------------[0m
2026-02-17 23:27:48 - BackgroundWorker - [33mWARNING[0m - ğŸ›¡ï¸ Filtered: Lead
2026-02-17 23:27:50 - BackgroundWorker - [32mINFO[0m - âœ… [BG] Visitor saved: anon...
2026-02-17 23:27:50 - httpx - [32mINFO[0m - HTTP Request: POST http://testserver/track/event "HTTP/1.1 200 OK"
[32mPASSED[0m
[1m------------------------------ live log teardown -------------------------------[0m
2026-02-17 23:27:50 - main - [32mINFO[0m - ğŸ›‘ Deteniendo servidor...


=================================== FAILURES ===================================
[31m[1m____________________ test_zero_tolerance_turnstile_missing _____________________[0m

client = <starlette.testclient.TestClient object at 0x7f1b53baf1c0>

    [0m[94mdef[39;49;00m[90m [39;49;00m[92mtest_zero_tolerance_turnstile_missing[39;49;00m(client):[90m[39;49;00m
        [96mprint[39;49;00m([33mf[39;49;00m[33m"[39;49;00m[33mDEBUG: settings.TURNSTILE_SECRET_KEY in test = [39;49;00m[33m'[39;49;00m[33m{[39;49;00msettings.TURNSTILE_SECRET_KEY[33m}[39;49;00m[33m'[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
    [90m    [39;49;00m[33m"""[39;49;00m
    [33m    ğŸ›¡ï¸ ARCHITECTURAL AUDIT: Zero Tolerance Policy (Missing Token)[39;49;00m
    [33m    Attempts to send a critical event (Lead) without a Turnstile token.[39;49;00m
    [33m    MUST fail with 403 or "Signal filtered".[39;49;00m
    [33m    """[39;49;00m[90m[39;49;00m
        payload = {[90m[39;49;00m
            [33m"[39;49;00m[33mevent_name[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mLead[39;49;00m[33m"[39;49;00m,[90m[39;49;00m
            [33m"[39;49;00m[33mevent_time[39;49;00m[33m"[39;49;00m: [94m1234567890[39;49;00m,[90m[39;49;00m
            [33m"[39;49;00m[33mevent_id[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mevt_123_hack[39;49;00m[33m"[39;49;00m,[90m[39;49;00m
            [33m"[39;49;00m[33muser_data[39;49;00m[33m"[39;49;00m: {[33m"[39;49;00m[33memail[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mbot@hack.com[39;49;00m[33m"[39;49;00m},[90m[39;49;00m
            [33m"[39;49;00m[33mevent_source_url[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mhttps://hack.com[39;49;00m[33m"[39;49;00m,[90m[39;49;00m
            [33m"[39;49;00m[33mcustom_data[39;49;00m[33m"[39;49;00m: {},  [90m# âŒ NO TOKEN[39;49;00m[90m[39;49;00m
        }[90m[39;49;00m
    [90m[39;49;00m
        [90m# We mock validate_turnstile to return False just in case (though missing token should fail before)[39;49;00m[90m[39;49;00m
        [90m# Actually, logic in tracking_routes.py _validate_human checks custom_data.get("turnstile_token")[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
        response = client.post([33m"[39;49;00m[33m/track/event[39;49;00m[33m"[39;49;00m, json=payload)[90m[39;49;00m
    [90m[39;49;00m
        [90m# Trace deleted for architecture compliance[39;49;00m[90m[39;49;00m
        [90m# assert response.status_code == 200 # Logic check later[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
        [90m# It might return 200 with "Signal filtered" message per current implementation[39;49;00m[90m[39;49;00m
        [90m# or 403 Forbidden. We accept either as long as it's NOT "queued".[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
        [94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
        json_resp = response.json()[90m[39;49;00m
>       [94massert[39;49;00m json_resp[[33m"[39;49;00m[33mstatus[39;49;00m[33m"[39;49;00m] != [33m"[39;49;00m[33mqueued[39;49;00m[33m"[39;49;00m, ([90m[39;49;00m
            [33m"[39;49;00m[33mâŒ SECURITY HOLE: Backend accepted event without Turnstile token![39;49;00m[33m"[39;49;00m[90m[39;49;00m
        )[90m[39;49;00m
[1m[31mE       AssertionError: âŒ SECURITY HOLE: Backend accepted event without Turnstile token![0m
[1m[31mE       assert 'queued' != 'queued'[0m

client     = <starlette.testclient.TestClient object at 0x7f1b53baf1c0>
json_resp  = {'event_id': 'evt_123_hack', 'status': 'queued'}
payload    = {'custom_data': {},
 'event_id': 'evt_123_hack',
 'event_name': 'Lead',
 'event_source_url': 'https://hack.com',
 'event_time': 1234567890,
 'user_data': {'email': 'bot@hack.com'}}
response   = <Response [200 OK]>

[1m[31mtests/L3_modules/test_strict_turnstile.py[0m:55: AssertionError
------------------------------ Captured log setup ------------------------------
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸš€ Iniciando Jorge Aguirre Flores Web v3.0.0 (Atomic Architecture Mode)
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ§ª Test mode detected: skipping warm_cache and init_tables
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸ“Š Meta Pixel ID: 1412977383680793
2026-02-17 23:27:45 - main - [32mINFO[0m - ğŸŒ Servidor listo en http://0.0.0.0:8000
------------------------------ Captured log call -------------------------------
2026-02-17 23:27:45 - uvicorn.error - [33mWARNING[0m - âš ï¸ TURNSTILE_SECRET_KEY not set (Value: '') â€” bot protection DISABLED.
2026-02-17 23:27:46 - httpx - [32mINFO[0m - HTTP Request: POST https://qstash.upstash.io/v2/publish/https://jorgeaguirreflores.com/hooks/process-event "HTTP/1.1 404 Not Found"
2026-02-17 23:27:46 - uvicorn.error - [31m[1mERROR[0m - âŒ QStash HTTP Error: 404 - {"error":"user bc0e128f-928d-4f0d-8c60-e24f2353c4dc not found"}
Traceback (most recent call last):
  File "/home/jorand/antigravityobuntu/app/services/__init__.py", line 302, in publish_to_qstash
    response.raise_for_status()
  File "/home/jorand/.local/lib/python3.10/site-packages/httpx/_models.py", line 829, in raise_for_status
    raise HTTPStatusError(message, request=request, response=self)
httpx.HTTPStatusError: Client error '404 Not Found' for url 'https://qstash.upstash.io/v2/publish/https://jorgeaguirreflores.com/hooks/process-event'
For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/404
2026-02-17 23:27:48 - BackgroundWorker - [32mINFO[0m - âœ… [BG] Visitor saved: anon...
2026-02-17 23:27:48 - httpx - [32mINFO[0m - HTTP Request: POST https://concise-reindeer-45748.upstash.io "HTTP/1.1 200 OK"
2026-02-17 23:27:48 - app.infrastructure.persistence.deduplication_service - [32mINFO[0m - ğŸ›‘ Duplicate detected: evt:evt_123_hack
2026-02-17 23:27:48 - uvicorn.error - [32mINFO[0m - ğŸ”„ [DEDUP ASYNC] Skipped duplicate Lead
2026-02-17 23:27:48 - BackgroundWorker - [32mINFO[0m - âœ… [BG] Meta Event sent: Lead
2026-02-17 23:27:48 - httpx - [32mINFO[0m - HTTP Request: POST http://testserver/track/event "HTTP/1.1 200 OK"
---------------------------- Captured log teardown -----------------------------
2026-02-17 23:27:48 - main - [32mINFO[0m - ğŸ›‘ Deteniendo servidor...
============================= slowest 10 durations =============================
2.99s call     L3_modules/test_strict_turnstile.py::test_zero_tolerance_turnstile_missing
1.93s call     L3_modules/test_strict_turnstile.py::test_zero_tolerance_turnstile_invalid

(4 durations < 1s hidden.)
[36m[1m=========================== short test summary info ============================[0m
[31mFAILED[0m tests/L3_modules/test_strict_turnstile.py::[1mtest_zero_tolerance_turnstile_missing[0m - AssertionError: âŒ SECURITY HOLE: Backend accepted event without Turnstile token!
assert 'queued' != 'queued'
[31m========================= [31m[1m1 failed[0m, [32m1 passed[0m[31m in 5.86s[0m[31m ==========================[0m
