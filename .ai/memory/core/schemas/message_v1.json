{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": ".ai/core/schemas/message_v1.json",
  "title": "NEXUS-7 Message Schema v1.0.0",
  "description": "Esquema unificado para todos los mensajes del sistema",
  "type": "object",
  "required": ["id", "type", "from", "to", "timestamp", "version", "payload"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Identificador único del mensaje",
      "pattern": "^msg_[0-9]{10}_[a-f0-9]{8}$"
    },
    "type": {
      "type": "string",
      "description": "Tipo de mensaje",
      "enum": ["task", "signal", "audit", "response", "command", "event"]
    },
    "from": {
      "type": "string",
      "description": "Emisor del mensaje",
      "enum": ["supervisor", "synapse", "orchestrator", "codex", "kimi", "gemini", "user", "system"]
    },
    "to": {
      "type": "string",
      "description": "Destinatario del mensaje (agente específico o broadcast)",
      "anyOf": [
        {"enum": ["codex", "kimi", "gemini", "orchestrator", "broadcast", "all"]},
        {"type": "string", "pattern": "^agent_.*$"}
      ]
    },
    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp",
      "format": "date-time"
    },
    "version": {
      "type": "string",
      "description": "Versión del esquema",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "payload": {
      "type": "object",
      "description": "Contenido específico según el tipo de mensaje",
      "additionalProperties": true
    },
    "trace": {
      "type": "object",
      "description": "Información de trazabilidad",
      "properties": {
        "parent_id": {
          "type": ["string", "null"],
          "description": "ID del mensaje padre (para conversaciones)"
        },
        "correlation_id": {
          "type": "string",
          "description": "ID de correlación para trazabilidad end-to-end"
        },
        "conversation_id": {
          "type": "string",
          "description": "ID de la conversación/flujo"
        }
      },
      "required": ["correlation_id"]
    },
    "priority": {
      "type": "string",
      "description": "Prioridad del mensaje",
      "enum": ["low", "normal", "high", "critical"],
      "default": "normal"
    },
    "ttl": {
      "type": "integer",
      "description": "Time-to-live en segundos",
      "minimum": 0,
      "default": 86400
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {"type": {"const": "task"}}
      },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["task_id", "content", "permissions"],
            "properties": {
              "task_id": {"type": "string"},
              "content": {"type": "string"},
              "permissions": {
                "type": "object",
                "properties": {
                  "read": {"type": "array", "items": {"type": "string"}},
                  "write": {"type": "array", "items": {"type": "string"}},
                  "deny": {"type": "array", "items": {"type": "string"}}
                }
              },
              "skill_id": {"type": "string"},
              "max_retries": {"type": "integer", "default": 3}
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {"type": {"const": "signal"}}
      },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["signal_type"],
            "properties": {
              "signal_type": {
                "type": "string",
                "enum": ["WAKE_UP", "HALT", "RETRY", "SKIP", "EMERGENCY"]
              },
              "data": {"type": "object"}
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {"type": {"const": "audit"}}
      },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["audit_type", "scope"],
            "properties": {
              "audit_type": {
                "type": "string",
                "enum": ["security", "architecture", "performance", "compliance"]
              },
              "scope": {"type": "array", "items": {"type": "string"}},
              "rules": {"type": "array", "items": {"type": "string"}}
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {"type": {"const": "response"}}
      },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "required": ["status", "request_id"],
            "properties": {
              "status": {"enum": ["success", "error", "partial"]},
              "request_id": {"type": "string"},
              "result": {"type": "object"},
              "errors": {"type": "array", "items": {"type": "object"}}
            }
          }
        }
      }
    }
  ]
}
