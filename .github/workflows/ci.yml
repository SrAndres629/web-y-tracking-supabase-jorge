name: "üõ°Ô∏è Silicon Valley Safety Net"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test_suite:
    name: üß™ Run Pytest
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx pytest-mock

    - name: Run Tests (Strict Integration Enabled)
      env:
        AUDIT_MODE: "1"
        REAL_INFRA: "1"
        SUPABASE_STRICT_AUDIT: "1"
        CLOUDFLARE_STRICT_AUDIT: "1"
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        REDIS_URL: ${{ secrets.REDIS_URL }}
        UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
        UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        META_PIXEL_ID: ${{ secrets.META_PIXEL_ID }}
        META_ACCESS_TOKEN: ${{ secrets.META_ACCESS_TOKEN }}
        QSTASH_TOKEN: ${{ secrets.QSTASH_TOKEN }}
        QSTASH_CURRENT_SIGNING_KEY: ${{ secrets.QSTASH_CURRENT_SIGNING_KEY }}
        QSTASH_NEXT_SIGNING_KEY: ${{ secrets.QSTASH_NEXT_SIGNING_KEY }}
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_API_KEY: ${{ secrets.CLOUDFLARE_API_KEY }}
        CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
        CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        CLOUDFLARE_ZONE_NAME: ${{ secrets.CLOUDFLARE_ZONE_NAME }}
        SUPABASE_POLICY_IGNORE: ${{ secrets.SUPABASE_POLICY_IGNORE }}
      run: |
        pytest tests/ -v
